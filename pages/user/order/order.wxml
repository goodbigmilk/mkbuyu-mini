<!--pages/user/order/order.wxml-->
<view class="order-page">
  <!-- æœç´¢æ  -->
  <view class="search-bar" wx:if="{{showSearch}}">
    <view class="search-input-wrapper">
      <input 
        class="search-input" 
        placeholder="æœç´¢è®¢å•å·ã€å•†å“åç§°" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="onSearch"
      />
      <text class="search-btn" bindtap="onSearch">æœç´¢</text>
    </view>
  </view>

  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="top-bar">
    <text class="search-icon" bindtap="toggleSearch">ğŸ”</text>
  </view>

  <!-- Tabåˆ‡æ¢ -->
  <view class="tabs">
    <scroll-view class="tabs-scroll" scroll-x="true">
      <view class="tab-list">
        <view 
          class="tab-item {{activeTab === item.key ? 'active' : ''}}" 
          wx:for="{{tabs}}" 
          wx:key="key"
          data-key="{{item.key}}"
          bindtap="onTabChange"
        >
          <text class="tab-title">{{item.title}}</text>
          <text class="tab-count" wx:if="{{item.count > 0}}">({{item.count}})</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <view class="order-item" wx:for="{{orderList}}" wx:key="id">
      <!-- è®¢å•å¤´éƒ¨ä¿¡æ¯ -->
      <view class="order-header" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
        <view class="order-info">
          <text class="order-no">è®¢å•å·ï¼š{{item.order_no}}</text>
          <text class="order-time">{{formatTime(item.created_at)}}</text>
        </view>
        <view class="order-status {{getStatusClass(item.status)}}">
          {{getStatusText(item.status)}}
        </view>
      </view>

      <!-- åº—é“ºä¿¡æ¯ -->
      <view class="shop-info" wx:if="{{item.shop}}" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
        <text class="shop-name">{{item.shop.name}}</text>
        <text class="arrow">></text>
      </view>

      <!-- å•†å“åˆ—è¡¨ -->
      <view class="product-list" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
        <view class="product-item" wx:for="{{item.items}}" wx:for-item="product" wx:key="id">
          <image class="product-image" src="{{product.product.images[0] || '/assets/images/default-product.png'}}" />
          <view class="product-info">
            <text class="product-name">{{product.product.name}}</text>
            <view class="product-meta">
              <text class="product-price">Â¥{{formatPrice(product.price)}}</text>
              <text class="product-quantity">x{{product.quantity}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- è®¢å•é‡‘é¢ -->
      <view class="order-amount" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
        <text class="amount-label">å®ä»˜æ¬¾ï¼š</text>
        <text class="amount-value">Â¥{{formatPrice(item.payment_amount)}}</text>
      </view>

      <!-- è®¢å•æ“ä½œæŒ‰é’® -->
      <view class="order-actions">
        <!-- å¾…ä»˜æ¬¾çŠ¶æ€ -->
        <block wx:if="{{item.status === 1}}">
          <button 
            class="action-btn cancel-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            data-order-no="{{item.order_no}}"
            bindtap="cancelOrder"
          >å–æ¶ˆè®¢å•</button>
          <button 
            class="action-btn pay-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            data-order-no="{{item.order_no}}"
            bindtap="goPay"
          >ç«‹å³æ”¯ä»˜</button>
        </block>

        <!-- å¾…å‘è´§çŠ¶æ€ -->
        <block wx:if="{{item.status === 2}}">
          <button 
            class="action-btn service-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="contactService"
          >è”ç³»å®¢æœ</button>
        </block>

        <!-- å¾…æ”¶è´§çŠ¶æ€ -->
        <block wx:if="{{item.status === 3}}">
          <button 
            class="action-btn service-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="contactService"
          >è”ç³»å®¢æœ</button>
          <button 
            class="action-btn confirm-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="confirmReceipt"
          >ç¡®è®¤æ”¶è´§</button>
        </block>

        <!-- å·²å®ŒæˆçŠ¶æ€ -->
        <block wx:if="{{item.status === 4}}">
          <button 
            class="action-btn service-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="contactService"
          >è”ç³»å®¢æœ</button>
          <button 
            class="action-btn delete-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="deleteOrder"
          >åˆ é™¤è®¢å•</button>
        </block>

        <!-- å·²å–æ¶ˆçŠ¶æ€ -->
        <block wx:if="{{item.status === 5}}">
          <button 
            class="action-btn delete-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="deleteOrder"
          >åˆ é™¤è®¢å•</button>
        </block>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="loading-more" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
    <view class="no-more" wx:if="{{!hasMore && orderList.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šè®¢å•äº†</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && orderList.length === 0}}">
      <image class="empty-icon" src="/assets/images/empty-order.png" />
      <text class="empty-text">æš‚æ— è®¢å•</text>
      <button class="empty-btn" bindtap="goShopping">å»è´­ç‰©</button>
    </view>
  </view>
</view>

<!-- ç”¨æˆ·åº•éƒ¨å¯¼èˆªæ  -->
<custom-tabbar />