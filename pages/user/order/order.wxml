<!--pages/user/order/order.wxml-->
<view class="order-page">
  <!-- 搜索栏 -->
  <view class="search-bar" wx:if="{{showSearch}}">
    <view class="search-input-wrapper">
      <input 
        class="search-input" 
        placeholder="搜索订单号、商品名称" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="onSearch"
      />
      <text class="search-btn" bindtap="onSearch">搜索</text>
    </view>
  </view>

  <!-- 顶部操作栏 -->
  <view class="top-bar">
    <text class="search-icon" bindtap="toggleSearch">🔍</text>
  </view>

  <!-- Tab切换 -->
  <view class="tabs">
    <scroll-view class="tabs-scroll" scroll-x="true">
      <view class="tab-list">
        <view 
          class="tab-item {{activeTab === item.key ? 'active' : ''}}" 
          wx:for="{{tabs}}" 
          wx:key="key"
          data-key="{{item.key}}"
          bindtap="onTabChange"
        >
          <text class="tab-title">{{item.title}}</text>
          <text class="tab-count" wx:if="{{item.count > 0}}">({{item.count}})</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 订单列表 -->
  <view class="order-list">
    <view class="order-item" wx:for="{{orderList}}" wx:key="id">
      <!-- 订单头部信息 -->
      <view class="order-header" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
        <view class="order-info">
          <text class="order-no">订单号：{{item.order_no}}</text>
          <text class="order-time">{{formatTime(item.created_at)}}</text>
        </view>
        <view class="order-status {{getStatusClass(item.status)}}">
          {{getStatusText(item.status)}}
        </view>
      </view>

      <!-- 店铺信息 -->
      <view class="shop-info" wx:if="{{item.shop}}" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
        <text class="shop-name">{{item.shop.name}}</text>
        <text class="arrow">></text>
      </view>

      <!-- 商品列表 -->
      <view class="product-list" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
        <view class="product-item" wx:for="{{item.items}}" wx:for-item="product" wx:key="id">
          <image class="product-image" src="{{product.product.images[0] || '/assets/images/default-product.png'}}" />
          <view class="product-info">
            <text class="product-name">{{product.product.name}}</text>
            <view class="product-meta">
              <text class="product-price">¥{{formatPrice(product.price)}}</text>
              <text class="product-quantity">x{{product.quantity}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 订单金额 -->
      <view class="order-amount" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
        <text class="amount-label">实付款：</text>
        <text class="amount-value">¥{{formatPrice(item.payment_amount)}}</text>
      </view>

      <!-- 订单操作按钮 -->
      <view class="order-actions">
        <!-- 待付款状态 -->
        <block wx:if="{{item.status === 1}}">
          <button 
            class="action-btn cancel-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            data-order-no="{{item.order_no}}"
            bindtap="cancelOrder"
          >取消订单</button>
          <button 
            class="action-btn pay-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            data-order-no="{{item.order_no}}"
            bindtap="goPay"
          >立即支付</button>
        </block>

        <!-- 待发货状态 -->
        <block wx:if="{{item.status === 2}}">
          <button 
            class="action-btn service-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="contactService"
          >联系客服</button>
        </block>

        <!-- 待收货状态 -->
        <block wx:if="{{item.status === 3}}">
          <button 
            class="action-btn service-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="contactService"
          >联系客服</button>
          <button 
            class="action-btn confirm-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="confirmReceipt"
          >确认收货</button>
        </block>

        <!-- 已完成状态 -->
        <block wx:if="{{item.status === 4}}">
          <button 
            class="action-btn service-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="contactService"
          >联系客服</button>
          <button 
            class="action-btn delete-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="deleteOrder"
          >删除订单</button>
        </block>

        <!-- 已取消状态 -->
        <block wx:if="{{item.status === 5}}">
          <button 
            class="action-btn delete-btn" 
            size="mini"
            data-order-id="{{item.id}}"
            bindtap="deleteOrder"
          >删除订单</button>
        </block>
      </view>
    </view>

    <!-- 加载更多 -->
    <view class="loading-more" wx:if="{{loading}}">
      <text>加载中...</text>
    </view>

    <!-- 没有更多数据 -->
    <view class="no-more" wx:if="{{!hasMore && orderList.length > 0}}">
      <text>没有更多订单了</text>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{!loading && orderList.length === 0}}">
      <image class="empty-icon" src="/assets/images/empty-order.png" />
      <text class="empty-text">暂无订单</text>
      <button class="empty-btn" bindtap="goShopping">去购物</button>
    </view>
  </view>
</view>

<!-- 用户底部导航栏 -->
<custom-tabbar />