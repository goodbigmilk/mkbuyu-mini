<view class="container">
  <!-- 用户信息卡片 -->
  <view class="user-card">
    <view class="user-header" bindtap="onAvatarTap">
      <image wx:if="{{userInfo.user.avatar}}" class="user-avatar" src="{{userInfo.user.avatar}}" />
      <view class="user-info">
        <view class="user-name">{{userInfo.user.nickname || '普通用户'}}</view>
        <view class="user-phone" wx:if="{{userInfo.user.phone}}">手机号: {{userInfo.user.phone}}</view>
      </view>
      <view class="user-actions">
        <van-icon name="edit" size="16" />
      </view>
    </view>
    

  </view>



  <!-- 功能菜单 -->
  <view class="menu-section">
    <view wx:for="{{menuGroups}}" wx:key="title" class="menu-group">
      <view wx:if="{{item.title}}" class="menu-title">{{item.title}}</view>
      <view class="menu-list">
        <view 
          wx:for="{{item.items}}" 
          wx:for-item="menuItem"
          wx:key="key"
          wx:if="{{menuItem.show !== false}}"
          class="menu-item"
          data-key="{{menuItem.key}}"
          bindtap="onMenuTap"
        >
          <view class="menu-icon">
            <van-icon name="{{menuItem.icon}}" size="20" />
          </view>
          <text class="menu-label">{{menuItem.label}}</text>
          <view class="menu-extra">
            <text wx:if="{{menuItem.extra}}" class="extra-text">{{menuItem.extra}}</text>
            <van-icon name="arrow" size="12" />
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 推荐码模态框 -->
  <van-popup 
    show="{{showReferralModal}}" 
    position="bottom" 
    closeable 
    bind:close="closeReferralModal"
    safe-area-inset-bottom
    z-index="9999"
  >
    <view class="referral-modal">
      <view class="modal-title">推荐码</view>
      
      <!-- 我的推荐码 -->
      <view class="referral-section">
        <view class="section-title">我的推荐码</view>
        <view class="referral-code-card" bindtap="copyReferralCode">
          <view class="code-text">{{referralInfo.referral_code || '获取中...'}}</view>
          <van-icon name="copy" size="16" />
          <text class="copy-hint">点击复制</text>
        </view>
      </view>

      <!-- 推荐人信息 -->
      <view class="referral-section" wx:if="{{referralInfo.has_referrer && referralInfo.referrer_info}}">
        <view class="section-title">我的推荐人</view>
        <view class="referrer-info">
          <view class="referrer-name">{{referralInfo.referrer_info.nickname}}</view>
          <view class="referrer-code" bindtap="copyReferrerCode">
            推荐码：{{referralInfo.referrer_info.referral_code}}
            <van-icon name="copy" size="14" />
          </view>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="referral-actions">
        <van-button 
          wx:if="{{!referralInfo.has_referrer}}" 
          type="primary" 
          size="large" 
          bindtap="showBindReferrerModal"
        >
          绑定推荐人
        </van-button>
        <van-button 
          wx:else 
          type="default" 
          size="large" 
          bindtap="showUpdateReferrerModal"
        >
          修改推荐人
        </van-button>
      </view>
    </view>
  </van-popup>

  <!-- 绑定/修改推荐人输入框 -->
  <van-popup 
    show="{{showInputDialog}}" 
    position="center"
    closeable
    bind:close="cancelReferralInput"
    z-index="10000"
    round
    overlay-style="background: rgba(0,0,0,0.7)"
  >
    <view class="referral-input-dialog">
      <view class="input-dialog-header">
        <text class="input-dialog-title">{{inputDialogTitle}}</text>
      </view>
      
      <view class="input-dialog-content">
        <van-field 
          value="{{inputReferralCode}}" 
          placeholder="请输入推荐码" 
          bind:input="onReferralCodeInput"
          bind:change="onReferralCodeInput"
          clearable
          border="{{false}}"
          custom-style="background: #f8f9fa; border-radius: 12rpx; padding: 20rpx;"
        />
      </view>
      
      <view class="input-dialog-actions">
        <van-button 
          class="cancel-btn" 
          size="large" 
          plain
          bindtap="cancelReferralInput"
        >
          取消
        </van-button>
        <van-button 
          class="confirm-btn" 
          size="large" 
          type="primary"
          bindtap="confirmReferralCode"
        >
          确认
        </van-button>
      </view>
    </view>
  </van-popup>

  <!-- 设置入口 -->
  <view class="settings-section">
    <view class="menu-item" bindtap="onSettings">
      <view class="menu-icon">
        <van-icon name="setting-o" size="20" />
      </view>
      <text class="menu-label">设置</text>
      <view class="menu-extra">
        <van-icon name="arrow" size="12" />
      </view>
    </view>
  </view>

  <!-- 商家端切换按钮 -->
  <view wx:if="{{hasDualRole}}" class="role-switch-section">
    <view>
      <van-button
              size="large"
              type="primary"
              bindtap="onSwitchToMerchant"
              custom-class="switch-to-merchant-btn"
      >
        切换到商家端
      </van-button>
    </view>
  </view>

  <!-- 底部间距 -->
  <view class="bottom-space"></view>
</view>

<!-- 自定义 TabBar -->
<custom-tabbar /> 