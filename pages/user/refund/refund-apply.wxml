<!--pages/user/refund/refund-apply.wxml-->
<view class="refund-apply-page">
  <!-- 订单信息 -->
  <view class="order-card" wx:if="{{orderInfo}}">
    <view class="card-title">退款订单</view>
    <view class="order-content">
      <view class="order-no">订单号：{{orderInfo.order_no}}</view>
      <view class="order-amount">订单金额：¥{{(orderInfo.payment_amount || orderInfo.total_amount) / 100}}</view>
    </view>
    
    <!-- 商品列表 -->
    <view class="product-list">
      <view class="product-item" wx:for="{{orderInfo.items}}" wx:key="id">
        <image 
          class="product-image" 
          src="{{item.product.images && item.product.images.length > 0 ? item.product.images[0].url : '/images/default-product.png'}}" 
          mode="aspectFill"
        />
        <view class="product-info">
          <text class="product-name">{{item.product.name}}</text>
          <text class="product-price">¥{{item.price / 100}} × {{item.quantity}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 退款金额 -->
  <view class="form-card">
    <view class="card-title">退款金额</view>
    <view class="amount-section">
      <view class="amount-item">
        <text class="amount-label">可退金额：</text>
        <text class="amount-value">¥{{maxRefundAmount / 100}}</text>
      </view>
      <view class="amount-input-wrapper">
        <text class="amount-label">申请退款：</text>
        <input 
          class="amount-input" 
          type="digit" 
          placeholder="请输入退款金额"
          value="{{refundAmount}}"
          bindinput="onRefundAmountInput"
          maxlength="10"
        />
        <text class="amount-unit">元</text>
      </view>
      <button class="max-amount-btn" bindtap="setMaxAmount">全额退款</button>
    </view>
  </view>

  <!-- 退款原因 -->
  <view class="form-card">
    <view class="card-title">退款原因</view>
    <view class="reason-section">
      <view class="reason-options">
        <view 
          class="reason-option {{selectedReason === item.value ? 'active' : ''}}"
          wx:for="{{reasonOptions}}" 
          wx:key="value"
          data-value="{{item.value}}"
          bindtap="selectReason"
        >
          {{item.label}}
        </view>
      </view>
      
      <!-- 详细原因输入（所有选项都需要） -->
      <view class="custom-reason" wx:if="{{selectedReason}}">
        <textarea 
          class="reason-textarea"
          placeholder="{{selectedReason === 'other' ? '请详细说明退款原因' : '请详细描述退款的具体情况'}}"
          value="{{customReason}}"
          bindinput="onCustomReasonInput"
          maxlength="500"
          show-confirm-bar="{{false}}"
        />
        <view class="char-count">{{customReason.length}}/500</view>
      </view>
    </view>
  </view>

  <!-- 上传凭证 -->
  <view class="form-card">
    <view class="card-title">
      <text>上传凭证</text>
      <text class="card-subtitle">（选填，最多上传9张图片）</text>
    </view>
    <view class="upload-section">
      <view class="image-list">
        <view class="image-item" wx:for="{{uploadedImages}}" wx:key="index">
          <image class="upload-image" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}" />
          <view class="delete-btn" bindtap="deleteImage" data-index="{{index}}">×</view>
        </view>
        
        <view class="upload-btn" wx:if="{{uploadedImages.length < 9}}" bindtap="chooseImage">
          <text class="upload-icon">+</text>
          <text class="upload-text">添加图片</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 温馨提示 -->
  <view class="tips-card">
    <view class="tips-title">温馨提示</view>
    <view class="tips-content">
      <text class="tip-item">• 退款申请提交后，商家将在1-3个工作日内处理</text>
      <text class="tip-item">• 退款成功后，退款金额将原路返回到您的支付账户</text>
      <text class="tip-item">• 如有疑问，请联系客服或店铺客服</text>
    </view>
  </view>

  <!-- 提交按钮 -->
  <view class="submit-section">
    <button 
      class="submit-btn {{canSubmit ? 'active' : 'disabled'}}" 
      bindtap="submitRefund"
      disabled="{{!canSubmit || submitting}}"
    >
      {{submitting ? '提交中...' : '提交退款申请'}}
    </button>
  </view>
</view>
