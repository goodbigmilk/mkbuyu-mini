<!--pages/common/order-detail/order-detail.wxml-->
<wxs module="utils">
  // 格式化价格（分转元）
  function formatPrice(price) {
    if (!price) return '0.00';
    return (price / 100).toFixed(2);
  }

  module.exports = {
    formatPrice: formatPrice
  };
</wxs>

<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <van-loading type="spinner" size="40rpx" text-size="28rpx">加载中...</van-loading>
  </view>

  <!-- 订单详情内容 -->
  <view wx:elif="{{orderDetail}}" class="order-detail">
    
    <!-- 订单状态卡片 -->
    <view class="status-card">
      <view class="status-info">
        <!-- 订单状态图标和颜色 -->
        <van-icon wx:if="{{orderDetail.status === 1}}" name="clock-o" size="60rpx" color="#ff6d00" />
        <van-icon wx:elif="{{orderDetail.status === 2}}" name="checked" size="60rpx" color="#1989fa" />
        <van-icon wx:elif="{{orderDetail.status === 3}}" name="checked" size="60rpx" color="#07c160" />
        <van-icon wx:elif="{{orderDetail.status === 4}}" name="checked" size="60rpx" color="#323233" />
        <van-icon wx:elif="{{orderDetail.status === 5}}" name="cross" size="60rpx" color="#c8c9cc" />
        <van-icon wx:elif="{{orderDetail.status === 6}}" name="warning-o" size="60rpx" color="#ff9500" />
        <van-icon wx:elif="{{orderDetail.status === 7}}" name="checked" size="60rpx" color="#28a745" />
        <van-icon wx:else name="warning-o" size="60rpx" color="#c8c9cc" />
        
        <view class="status-text">
          <!-- 订单状态文本 -->
          <text class="status-title" wx:if="{{orderDetail.status === 1}}">待付款</text>
          <text class="status-title" wx:elif="{{orderDetail.status === 2}}">待发货</text>
          <text class="status-title" wx:elif="{{orderDetail.status === 3}}">待收货</text>
          <text class="status-title" wx:elif="{{orderDetail.status === 4}}">已完成</text>
          <text class="status-title" wx:elif="{{orderDetail.status === 5}}">已取消</text>
          <text class="status-title" wx:elif="{{orderDetail.status === 6}}">退款中</text>
          <text class="status-title" wx:elif="{{orderDetail.status === 7}}">已退款</text>
          <text class="status-title" wx:else>未知状态</text>
          
          <text wx:if="{{orderDetail.status === 1 && countdownDisplay}}" class="countdown-text">
            剩余支付时间 {{countdownDisplay}}
          </text>
        </view>
      </view>
      
      <!-- 订单基本信息 -->
      <view class="order-info">
        <view class="order-item">
          <text class="label">订单号：</text>
          <text class="value" bindtap="onCopyOrderNo">{{orderDetail.order_no}}</text>
          <van-icon name="copy" size="28rpx" color="#1989fa" />
        </view>
        <view class="order-item">
          <text class="label">下单时间：</text>
          <text class="value">{{orderDetail.created_at}}</text>
        </view>
        <view wx:if="{{orderDetail.shop}}" class="order-item">
          <text class="label">店铺：</text>
          <text class="value">{{orderDetail.shop.name}}</text>
        </view>
      </view>
    </view>

    <!-- 商品列表 -->
    <view class="products-section">
      <view class="section-header">
        <text class="section-title">商品信息</text>
        <text class="item-count">共 {{orderDetail.items.length}} 件商品</text>
      </view>
      
      <view class="product-list">
        <view wx:for="{{orderDetail.items}}" 
              wx:key="id" 
              class="product-item"
              bindtap="onProductTap"
              data-product="{{item.product}}">
          
          <!-- 商品图片 -->
          <view class="product-image">
            <image 
              src="{{item.product && item.product.images && item.product.images.length > 0 ? item.product.images[0].url : ''}}" 
              mode="aspectFill" />
          </view>
          
          <!-- 商品信息 -->
          <view class="product-info">
            <view class="product-name">{{item.product ? item.product.name : '商品已删除'}}</view>
            <view wx:if="{{item.product && item.product.sub_title}}" class="product-subtitle">
              {{item.product.sub_title}}
            </view>
            
            <!-- 商品标签 -->
            <view wx:if="{{item.product}}" class="product-tags">
              <van-tag wx:if="{{item.product.is_hot}}" size="mini" color="#ff6d00">热门</van-tag>
              <van-tag wx:if="{{item.product.is_new}}" size="mini" color="#4caf50">新品</van-tag>
              <van-tag wx:if="{{item.product.is_recommend}}" size="mini" color="#9c27b0">推荐</van-tag>
            </view>
            
            <!-- 价格和数量 -->
            <view class="product-price-quantity">
              <text class="product-price">¥{{utils.formatPrice(item.price)}}</text>
              <text class="product-quantity">×{{item.quantity}}</text>
            </view>
          </view>
          
          <!-- 小计金额 -->
          <view class="product-total">
            <text class="total-price">¥{{utils.formatPrice(item.total_amount)}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 费用明细 -->
    <view class="amount-section">
      <view class="section-header">
        <text class="section-title">费用明细</text>
      </view>
      
      <view class="amount-list">
        <view class="amount-item">
          <text class="amount-label">商品总价</text>
          <text class="amount-value">¥{{utils.formatPrice(orderDetail.product_amount)}}</text>
        </view>
        <view wx:if="{{orderDetail.shipping_amount > 0}}" class="amount-item">
          <text class="amount-label">运费</text>
          <text class="amount-value">¥{{utils.formatPrice(orderDetail.shipping_amount)}}</text>
        </view>
        <view wx:if="{{orderDetail.discount_amount > 0}}" class="amount-item">
          <text class="amount-label">商品优惠</text>
          <text class="amount-value discount">-¥{{utils.formatPrice(orderDetail.discount_amount)}}</text>
        </view>
        <view wx:if="{{orderDetail.coupon_amount > 0}}" class="amount-item">
          <text class="amount-label">优惠券</text>
          <text class="amount-value discount">-¥{{utils.formatPrice(orderDetail.coupon_amount)}}</text>
        </view>
        
        <van-divider />
        
        <view class="amount-item total">
          <text class="amount-label">实付金额</text>
          <text class="amount-value total-price" wx:if="{{orderDetail.payment_amount === 0}}">未付款</text>
          <text class="amount-value total-price" wx:else>¥{{utils.formatPrice(orderDetail.payment_amount)}}</text>
        </view>
      </view>
    </view>

    <!-- 订单备注 -->
    <view wx:if="{{orderDetail.remark}}" class="remark-section">
      <view class="section-header">
        <text class="section-title">订单备注</text>
      </view>
      <view class="remark-content">
        <text>{{orderDetail.remark}}</text>
      </view>
    </view>

    <!-- 底部操作栏 -->
    <view class="bottom-actions">
      <view class="action-buttons">
        <!-- 取消订单按钮 -->
        <van-button wx:if="{{orderDetail.status === 1}}"
                    type="default" 
                    size="large"
                    custom-class="cancel-btn"
                    icon="cross"
                    bindtap="onCancelOrder">
          取消订单
        </van-button>
        
        <!-- 立即付款按钮 -->
        <van-button wx:if="{{orderDetail.status === 1}}"
                    type="primary" 
                    size="large"
                    custom-class="pay-btn"
                    icon="gold-coin-o"
                    bindtap="onShowPayment">
          立即付款
        </van-button>
        
        <!-- 确认收货按钮 -->
        <van-button wx:if="{{orderDetail.status === 3}}"
                    type="primary" 
                    size="large"
                    custom-class="confirm-btn"
                    icon="passed"
                    bindtap="onConfirmReceipt">
          确认收货
        </van-button>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:else class="empty-wrapper">
    <van-empty description="订单不存在或已被删除" />
  </view>
</view>

<!-- 支付组件 -->
<payment-modal 
  show="{{showPaymentModal}}"
  payment-amount="{{orderDetail ? orderDetail.total_amount : 0}}"
  order-info="{{orderDetail}}"
  bind:close="onHidePayment"
  bind:paymentSuccess="onPaymentSuccess"
  bind:paymentError="onPaymentError"
/> 