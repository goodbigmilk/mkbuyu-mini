<!--pages/merchant/orders/orders.wxml-->
<wxs module="utils">
  // 格式化时间
  function formatTime(timestamp) {
    if (!timestamp) return '';
    var date = getDate(timestamp);
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();
    
    month = month < 10 ? '0' + month : month;
    day = day < 10 ? '0' + day : day;
    hour = hour < 10 ? '0' + hour : hour;
    minute = minute < 10 ? '0' + minute : minute;
    
    return year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
  }
  
  module.exports = {
    formatTime: formatTime
  };
</wxs>
<view class="order-page">
  <!-- 搜索栏 -->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <input 
        class="search-input" 
        placeholder="搜索订单号、商品名称" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="onSearch"
      />
      <text class="clear-btn" wx:if="{{searchKeyword}}" bindtap="clearSearch">✕</text>
      <text class="search-btn" bindtap="onSearch">搜索</text>
    </view>
  </view>

  <!-- Tab切换 -->
  <view class="tabs">
    <scroll-view class="tabs-scroll" scroll-x="true">
      <view class="tab-list">
        <view 
          class="tab-item {{activeTab === item.key ? 'active' : ''}}" 
          wx:for="{{tabs}}" 
          wx:key="key"
          data-key="{{item.key}}"
          bindtap="onTabChange"
        >
          <text class="tab-title">{{item.title}}</text>
          <view wx:if="{{item.count > 0}}" class="tab-count">{{item.count}}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 订单列表 -->
  <scroll-view class="order-list-container" scroll-y="true" enable-back-to-top="true">
    <view class="order-list">
      <view class="order-item" wx:for="{{orderList}}" wx:key="id">
        <!-- 订单头部信息 -->
        <view class="order-header" bindtap="viewOrderDetail" data-order-id="{{item.id}}">
          <view class="order-main-info">
            <view class="order-no-row">
              <text class="order-no">订单号：{{item.order_no}}</text>
              <!-- 订单状态显示 -->
              <view class="order-status status-pending" wx:if="{{item.status === 1}}">待付款</view>
              <view class="order-status status-paid" wx:elif="{{item.status === 2}}">待发货</view>
              <view class="order-status status-shipped" wx:elif="{{item.status === 3}}">已发货</view>
              <view class="order-status status-completed" wx:elif="{{item.status === 4}}">已完成</view>
              <view class="order-status status-cancelled" wx:elif="{{item.status === 5}}">已取消</view>
              <view class="order-status status-refunding" wx:elif="{{item.status === 6}}">退款中</view>
              <view class="order-status status-refunded" wx:elif="{{item.status === 7}}">已退款</view>
              <view class="order-status" wx:else>未知状态</view>
            </view>
            
            <!-- 买家信息行 -->
            <view class="buyer-row" wx:if="{{item.user}}">
              <text class="buyer-label">买家昵称：</text>
              <text class="buyer-name">{{item.user.nickname}}</text>
              <text class="order-time">{{utils.formatTime(item.created_at)}}</text>
            </view>

            <view class="buyer-row" wx:if="{{item.user}}">
              <text class="buyer-label">买家注册电话：</text>
              <text class="buyer-name">{{item.user.phone}}</text>
              <text class="order-time">{{utils.formatTime(item.created_at)}}</text>
            </view>

            <!-- 商品数量信息 -->
            <view class="product-count-row" wx:if="{{item.items && item.items.length > 0}}">
              <text class="product-count-label">商品：</text>
              <text class="product-count">{{item.items.length}}件商品</text>
            </view>

            <!-- 订单金额信息 - 移到商品信息下方 -->
            <view class="amount-section">
              <text class="amount-label">订单金额：</text>
              <text class="amount-value">¥{{item.payment_amount/100}}</text>
            </view>
          </view>
        </view>

        <!-- 订单地址信息 -->
        <view class="order-summary" bindtap="viewOrderDetail" data-order-id="{{item.id}}" wx:if="{{item.receiver_address}}">
          <view class="address-section">
            <text class="address-label">收货地址：</text>
            <text class="address-detail">{{item.receiver_address}}</text>
          </view>
        </view>

        <!-- 商家订单操作按钮 -->
        <view class="order-actions">
          <!-- 待发货状态 - 显示发货按钮 -->
          <block wx:if="{{item.status === 2}}">
            <button 
              class="action-btn contact-btn" 
              size="mini"
              data-order-id="{{item.id}}"
              bindtap="contactBuyer"
            >联系买家</button>
            <button 
              class="action-btn ship-btn" 
              size="mini"
              data-order-id="{{item.id}}"
              data-order="{{item}}"
              bindtap="shipOrder"
            >发货</button>
          </block>

          <!-- 已发货状态 -->
          <block wx:if="{{item.status === 3}}">
            <button 
              class="action-btn contact-btn" 
              size="mini"
              data-order-id="{{item.id}}"
              bindtap="contactBuyer"
            >联系买家</button>
            <button 
              class="action-btn express-btn" 
              size="mini"
              data-order="{{item}}"
              bindtap="viewExpress"
            >查看物流</button>
          </block>

          <!-- 已完成状态 -->
          <block wx:if="{{item.status === 4}}">
            <button 
              class="action-btn contact-btn" 
              size="mini"
              data-order-id="{{item.id}}"
              bindtap="contactBuyer"
            >联系买家</button>
          </block>

          <!-- 其他状态 -->
          <block wx:if="{{item.status === 1 || item.status === 5}}">
            <button 
              class="action-btn contact-btn" 
              size="mini"
              data-order-id="{{item.id}}"
              bindtap="contactBuyer"
            >联系买家</button>
          </block>
        </view>
      </view>

      <!-- 加载更多 -->
      <view class="loading-more" wx:if="{{loading}}">
        <text>加载中...</text>
      </view>

      <!-- 没有更多数据 -->
      <view class="no-more" wx:if="{{!hasMore && orderList.length > 0}}">
        <text>没有更多订单了</text>
      </view>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{!loading && orderList.length === 0}}">

        <text class="empty-text">暂无订单</text>
        <button class="empty-btn" bindtap="goManageProducts">去管理商品</button>
      </view>
    </view>
  </scroll-view>
</view>

<!-- 商家底部导航栏 -->
<merchant-tabbar current="{{tabbarCurrent}}" /> 